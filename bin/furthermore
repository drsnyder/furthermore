#!/usr/bin/env python
# vim: set expandtab textwidth=79 ts=4 sts=4 ft=python:
import re
import os
import sys
import textile
from mako.template import Template
from optparse import OptionParser

sys.path.append("%s/../lib" % os.path.dirname(__file__))

import furthermore
from LocalHTTPServer import *

if __name__ == '__main__':
    usage = """usage: %prog [options]

    """ 


    parser = OptionParser(usage)
    parser.add_option("-f", "--file", dest="file", help="file to process")
    parser.add_option("-o", "--out", dest="out", help="file to write out to")
    parser.add_option("-T", "--template_dir", dest="template_dir", \
            default="%s/../templates" % os.path.dirname(__file__), \
            help="template directory")

    parser.add_option("-P", "--process-posts", dest="process_posts", \
            help="process posts")
    parser.add_option("-b", "--base", dest="base", \
            default="%s/../" % os.path.dirname(__file__), help="base directory")

    parser.add_option("-S", "--server", dest="server", action="store_true", \
            default=False, help="start local web server")
    parser.add_option("-p", "--port", dest="port", default=8080, \
            help="start local web server on this port")

    (options, args) = parser.parse_args()


    if options.file != None:
        (header, content) = furthermore.parse_document_file(options.file)
        text = furthermore.render_document(header, content)
        if options.out != None:
            fd = open(options.out, "w")
            fd.write(text)
            fd.close()
        else:
            print text

    if options.base == None:
        options.base = "%s/../" % os.path.dirname(__file__)

    if options.out == None:
        options.out = "%s/../out" % os.path.dirname(__file__)

    if options.process_posts != None:
        posts = furthermore.get_posts(options.base)
        # TODO: process these posts


    if options.server == True:
        os.system("rsync -avz --exclude '.svn' %s/../css %s/ > /dev/null" % \
                (os.path.dirname(__file__), options.out))
        server = LocalHTTPServer(options.port, options.out)
        server.run()

